# 缓存架构图

## 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        Application Layer                         │
│                     (RBAC, Policy, Authorization)                │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                         AuthCache                                │
│  (用户角色、角色、策略缓存 - 支持可配置 TTL)                      │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    MultiLayerCache (可选)                        │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  L1: 本地内存缓存 (Moka)                                  │   │
│  │  - 容量: 10,000 条                                        │   │
│  │  - TTL: 60 秒                                             │   │
│  │  - 响应时间: < 1ms                                        │   │
│  └──────────────────────────────────────────────────────────┘   │
│                             │                                    │
│                             ▼                                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  L2: Redis 缓存                                           │   │
│  │  - 共享缓存                                               │   │
│  │  - TTL: 300-600 秒 (带抖动)                               │   │
│  │  - 响应时间: ~2ms                                         │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  故障处理: L2 失败 → 自动降级到 L1                              │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│              AvalancheProtectedCache (推荐)                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  TTL 随机抖动                                             │   │
│  │  - 基础 TTL ± 抖动范围                                    │   │
│  │  - 例: 300s → 270-330s                                    │   │
│  │  - 防止缓存雪崩                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Singleflight 模式                                        │   │
│  │  - 合并并发请求                                           │   │
│  │  - 10 个并发 → 1 个实际查询                               │   │
│  │  - 防止缓存击穿                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      RedisCache (基础层)                         │
│  - 单实例 Redis                                                  │
│  - 支持所有 Redis 命令                                           │
│  - 原子操作 (SETNX, Lua 脚本)                                    │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
                      ┌──────────────┐
                      │    Redis     │
                      │  (单实例)     │
                      └──────────────┘
```

## 数据流

### 读取流程 (GET)

```
Application
    │
    ▼
AuthCache.get_user_roles()
    │
    ▼
MultiLayerCache.get()
    │
    ├─→ L1 Cache (内存)
    │   ├─→ 命中 ✓ → 返回 (0.1ms)
    │   └─→ 未命中 ✗
    │       │
    │       ▼
    └─→ L2 Cache (Redis)
        │
        ▼
    AvalancheProtectedCache.get()
        │
        ├─→ Singleflight 检查
        │   ├─→ 已有请求在进行 → 等待结果
        │   └─→ 无请求 → 继续
        │
        ▼
    RedisCache.get()
        │
        ├─→ 命中 ✓ → 回填 L1 → 返回 (2ms)
        ├─→ 未命中 ✗ → 查询数据库 → 写入缓存 (50ms)
        └─→ 错误 ✗ → 降级到 L1 (如果有)
```

### 写入流程 (SET)

```
Application
    │
    ▼
AuthCache.set_user_roles()
    │
    ▼
MultiLayerCache.set()
    │
    ├─→ L1 Cache (内存) ✓
    │
    ▼
AvalancheProtectedCache.set()
    │
    ├─→ 添加 TTL 抖动 (300s → 270-330s)
    │
    ▼
RedisCache.set()
    │
    ├─→ 成功 ✓
    └─→ 失败 ✗ → 降级模式 (只写 L1)
```

## 防护机制

### 1. 缓存雪崩防护

```
原问题:
┌─────┐ ┌─────┐ ┌─────┐
│ 300s│ │ 300s│ │ 300s│  ← 所有缓存同时过期
└──┬──┘ └──┬──┘ └──┬──┘
   │       │       │
   └───────┴───────┘
         │
         ▼
    数据库压力峰值 💥

解决方案:
┌─────┐ ┌─────┐ ┌─────┐
│ 285s│ │ 310s│ │ 295s│  ← TTL 随机抖动
└──┬──┘ └──┬──┘ └──┬──┘
   │       │       │
   └───────┴───────┘
         │
         ▼
    压力分散 ✓
```

### 2. 缓存击穿防护

```
原问题:
热点 Key 过期
    │
    ▼
┌───┬───┬───┬───┬───┐
│ R │ R │ R │ R │ R │  ← 10 个并发请求
└─┬─┴─┬─┴─┬─┴─┬─┴─┬─┘
  │   │   │   │   │
  └───┴───┴───┴───┘
         │
         ▼
    数据库压力 💥

解决方案:
热点 Key 过期
    │
    ▼
┌───┬───┬───┬───┬───┐
│ R │ R │ R │ R │ R │  ← 10 个并发请求
└─┬─┴─┬─┴─┬─┴─┬─┴─┬─┘
  │   │   │   │   │
  └───┴───┴───┴───┘
         │
         ▼
   Singleflight 合并
         │
         ▼
    只有 1 个查询 ✓
```

### 3. 缓存穿透防护

```
原问题:
查询不存在的 Key
    │
    ▼
Cache Miss
    │
    ▼
Database Query  ← 每次都查询
    │
    ▼
Not Found

解决方案:
查询不存在的 Key
    │
    ▼
Bloom Filter 检查
    │
    ├─→ 不存在 → 直接返回 ✓
    │
    └─→ 可能存在
        │
        ▼
    Cache Miss
        │
        ▼
    Database Query
```

### 4. Redis 故障降级

```
正常情况:
Request → L1 (80% 命中) → L2 (15% 命中) → DB (5%)

Redis 故障:
Request → L1 (80% 命中) → DB (20%)
                ↑
                └─ L2 失败自动降级
```

## 缓存预热流程

```
应用启动
    │
    ▼
后台任务启动
    │
    ├─→ 加载租户列表
    │
    ├─→ 并发预热策略
    │   │
    │   ├─→ Tenant 1 策略 → 写入缓存
    │   ├─→ Tenant 2 策略 → 写入缓存
    │   └─→ Tenant N 策略 → 写入缓存
    │
    └─→ 并发预热角色
        │
        ├─→ 热点角色 1 → 写入缓存
        ├─→ 热点角色 2 → 写入缓存
        └─→ 热点角色 N → 写入缓存
    │
    ▼
预热完成 ✓
缓存命中率: 0% → 80%+
```

## 配置层次

```
┌─────────────────────────────────────────┐
│      CacheStrategyConfig (顶层)         │
│  - enable_multi_layer                   │
│  - enable_avalanche_protection          │
│  - enable_bloom_filter                  │
│  - enable_cache_warming                 │
│  - jitter_range_secs                    │
├─────────────────────────────────────────┤
│      AuthCacheConfig (业务层)           │
│  - user_roles_ttl_secs: 300            │
│  - role_ttl_secs: 600                  │
│  - policy_ttl_secs: 600                │
├─────────────────────────────────────────┤
│    MultiLayerCacheConfig (缓存层)       │
│  - l1_max_capacity: 10,000             │
│  - l1_ttl_secs: 60                     │
│  - fallback_to_l1: true                │
└─────────────────────────────────────────┘
```

## 性能指标

### 响应时间分布

```
L1 命中 (80%):  ████████████████████████████████████████ 0.1ms
L2 命中 (15%):  ███████                                  2ms
DB 查询 (5%):   ██                                       50ms
```

### 缓存命中率变化

```
改进前:
┌────────────────────────────────────────┐
│ 命中: 85%  ████████████████████████    │
│ 未命中: 15% ████                       │
└────────────────────────────────────────┘

改进后 (正常):
┌────────────────────────────────────────┐
│ L1 命中: 80% ████████████████████████  │
│ L2 命中: 15% ████                      │
│ 未命中: 5%   █                         │
└────────────────────────────────────────┘

改进后 (Redis 故障):
┌────────────────────────────────────────┐
│ L1 命中: 80% ████████████████████████  │
│ 未命中: 20%  █████                     │
└────────────────────────────────────────┘
```

## 故障场景对比

### 场景 1: Redis 正常运行

```
改进前:
Request → Redis (85% 命中) → DB (15%)
QPS: 1500 → Redis, 225 → DB

改进后:
Request → L1 (80% 命中) → L2 (15% 命中) → DB (5%)
QPS: 1200 → L1, 225 → L2, 75 → DB
```

### 场景 2: Redis 故障

```
改进前:
Request → Redis (失败) → DB (100%)
QPS: 0 → Redis, 1500 → DB
服务: 不可用 ❌

改进后:
Request → L1 (80% 命中) → DB (20%)
QPS: 1200 → L1, 300 → DB
服务: 可用 ✓
```

### 场景 3: 缓存雪崩

```
改进前:
大量 Key 同时过期
QPS: 50,000 → DB
数据库: 崩溃 💥

改进后:
Key 分散过期 + Singleflight
QPS: 1,000 → DB
数据库: 正常 ✓
```

## 监控仪表板

```
┌─────────────────────────────────────────────────────────┐
│                   缓存监控仪表板                         │
├─────────────────────────────────────────────────────────┤
│ 缓存命中率                                               │
│ L1: ████████████████████ 80%                            │
│ L2: ████ 15%                                            │
│ Miss: █ 5%                                              │
├─────────────────────────────────────────────────────────┤
│ 响应时间 (P99)                                          │
│ L1: 0.5ms  L2: 5ms  DB: 100ms                          │
├─────────────────────────────────────────────────────────┤
│ Singleflight 合并率                                     │
│ 合并: ████████ 40%                                      │
├─────────────────────────────────────────────────────────┤
│ 降级次数                                                │
│ 最近 1 小时: 0 次 ✓                                     │
├─────────────────────────────────────────────────────────┤
│ 数据库 QPS                                              │
│ 当前: 75 QPS (正常)                                     │
└─────────────────────────────────────────────────────────┘
```

## 总结

这套缓存架构提供了：

1. **多层防护**: 雪崩、击穿、穿透三重防护
2. **高可用**: Redis 故障时自动降级
3. **高性能**: L1 缓存响应时间 < 1ms
4. **易扩展**: 模块化设计，可选择性启用
5. **可观测**: 完善的日志和监控

通过这些改进，系统在各种故障场景下都能保持稳定运行。
