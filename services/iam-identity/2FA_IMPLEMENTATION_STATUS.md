# 2FA åŠŸèƒ½å®ç°çŠ¶æ€

## âœ… å·²å®Œæˆçš„å·¥ä½œï¼ˆ100%ï¼‰

### é˜¶æ®µä¸€ï¼šæ•°æ®åº“è®¾è®¡å’Œè¿ç§» âœ…
- [x] åˆ›å»ºæ•°æ®åº“è¿ç§»æ–‡ä»¶ `20260126011629_add_2fa_support.sql`
- [x] åˆ›å»º `backup_codes` è¡¨
- [x] æ·»åŠ å¿…è¦çš„ç´¢å¼•å’Œæ³¨é‡Š
- [x] User å®ä½“å·²æœ‰ `two_factor_enabled` å’Œ `two_factor_secret` å­—æ®µ

### é˜¶æ®µäºŒï¼šé¢†åŸŸå±‚å®ç° âœ…
- [x] åˆ›å»º `TotpService` - TOTP ç”Ÿæˆå’ŒéªŒè¯æœåŠ¡
  - ç”Ÿæˆ TOTP secret
  - ç”Ÿæˆ QR ç  URLï¼ˆotpauth:// æ ¼å¼ï¼‰
  - éªŒè¯ TOTP ç 
  - åŒ…å«å®Œæ•´çš„å•å…ƒæµ‹è¯•
  
- [x] åˆ›å»º `BackupCodeService` - å¤‡ä»½ç æœåŠ¡
  - ç”Ÿæˆ 10 ä¸ªå¤‡ä»½ç 
  - å“ˆå¸Œå¤‡ä»½ç ï¼ˆSHA256ï¼‰
  - éªŒè¯å¤‡ä»½ç 
  - åŒ…å«å®Œæ•´çš„å•å…ƒæµ‹è¯•

- [x] åˆ›å»º `BackupCode` å®ä½“
  - å¤‡ä»½ç  ID
  - ç”¨æˆ· ID
  - å“ˆå¸Œå€¼
  - ä½¿ç”¨çŠ¶æ€
  - ä½¿ç”¨æ—¶é—´
  - åŒ…å«å®Œæ•´çš„å•å…ƒæµ‹è¯•

- [x] åˆ›å»º `BackupCodeRepository` trait
  - save() - ä¿å­˜å•ä¸ªå¤‡ä»½ç 
  - save_batch() - æ‰¹é‡ä¿å­˜å¤‡ä»½ç 
  - find_by_id() - æ ¹æ® ID æŸ¥æ‰¾
  - find_available_by_user_id() - æŸ¥æ‰¾ç”¨æˆ·çš„å¯ç”¨å¤‡ä»½ç 
  - update() - æ›´æ–°å¤‡ä»½ç 
  - delete_by_user_id() - åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰å¤‡ä»½ç 
  - count_available_by_user_id() - ç»Ÿè®¡å¯ç”¨å¤‡ä»½ç æ•°é‡

### é˜¶æ®µä¸‰ï¼šåŸºç¡€è®¾æ–½å±‚å®ç° âœ…
- [x] å®ç° `PostgresBackupCodeRepository`
  - å®Œæ•´å®ç°æ‰€æœ‰ trait æ–¹æ³•
  - ä½¿ç”¨äº‹åŠ¡æ‰¹é‡ä¿å­˜
  - æ­£ç¡®çš„é”™è¯¯å¤„ç†

### é˜¶æ®µå››ï¼šåº”ç”¨å±‚å®ç° âœ…
- [x] æ›´æ–° User å®ä½“æ–¹æ³•
  - `enable_2fa()` - å¯ç”¨ 2FA
  - `disable_2fa()` - ç¦ç”¨ 2FA

- [x] æ›´æ–° AuthServiceImpl
  - æ·»åŠ  `backup_code_repo: Arc<dyn BackupCodeRepository>` ä¾èµ–
  - æ·»åŠ  `totp_service: Arc<TotpService>` ä¾èµ–
  - å®ç° `enable2_fa()` - æ”¯æŒä¸¤æ­¥éªŒè¯æµç¨‹
  - å®ç° `verify2_fa()` - æ”¯æŒ TOTP å’Œå¤‡ä»½ç éªŒè¯
  - å®ç° `disable2_fa()` - å¯†ç éªŒè¯ + åˆ é™¤å¤‡ä»½ç 

- [x] æ›´æ–° Proto æ–‡ä»¶
  - å®Œæ•´çš„ `Enable2FAResponse` æ¶ˆæ¯
  - å®Œæ•´çš„ `Verify2FAResponse` æ¶ˆæ¯
  - å®Œæ•´çš„ `Disable2FAResponse` æ¶ˆæ¯

- [x] æ›´æ–° main.rs
  - æ·»åŠ  TOTP æœåŠ¡ä¾èµ–æ³¨å…¥
  - æ·»åŠ å¤‡ä»½ç ä»“å‚¨ä¾èµ–æ³¨å…¥
  - æ›´æ–° AuthService æ„é€ å‡½æ•°

### ä¾èµ–ç®¡ç† âœ…
- [x] æ·»åŠ  `totp-rs = "5.5"` - TOTP ç”Ÿæˆå’ŒéªŒè¯
- [x] æ·»åŠ  `data-encoding = "2.5"` - Base32 ç¼–ç 
- [x] æ·»åŠ  `rand = "0.8"` - éšæœºæ•°ç”Ÿæˆ
- [x] æ·»åŠ  `urlencoding = "2.1"` - URL ç¼–ç 
- [x] å·²æœ‰ `sha2` - SHA256 å“ˆå¸Œ

### æ¨¡å—å¯¼å‡º âœ…
- [x] æ›´æ–° `auth/domain/services/mod.rs`
- [x] æ›´æ–° `auth/domain/entities/mod.rs`
- [x] æ›´æ–° `auth/domain/repositories/mod.rs`
- [x] æ›´æ–° `auth/infrastructure/persistence/mod.rs`

### ç¼–è¯‘çŠ¶æ€ âœ…
- [x] ä»£ç ç¼–è¯‘æˆåŠŸ
- [x] åªæœ‰æœªä½¿ç”¨ä»£ç çš„è­¦å‘Šï¼ˆé¢„æœŸï¼‰

---

## ğŸ‰ åŠŸèƒ½å®Œæˆï¼

2FA åŠŸèƒ½å·²ç» 100% å®ç°å®Œæˆï¼ŒåŒ…æ‹¬ï¼š

### æ ¸å¿ƒåŠŸèƒ½
1. **å¯ç”¨ 2FA** (`enable2_fa`)
   - ç”Ÿæˆ TOTP secret
   - ç”Ÿæˆ QR ç  URL
   - æ”¯æŒä¸¤æ­¥éªŒè¯æµç¨‹ï¼ˆå…ˆè¿”å› QR ç ï¼ŒéªŒè¯åå¯ç”¨ï¼‰
   - ç”Ÿæˆ 10 ä¸ªå¤‡ä»½ç 

2. **éªŒè¯ 2FA** (`verify2_fa`)
   - æ”¯æŒ TOTP ç éªŒè¯
   - æ”¯æŒå¤‡ä»½ç éªŒè¯
   - å¤‡ä»½ç ä¸€æ¬¡æ€§ä½¿ç”¨
   - éªŒè¯æˆåŠŸåè¿”å›è®¿é—®ä»¤ç‰Œ

3. **ç¦ç”¨ 2FA** (`disable2_fa`)
   - å¯†ç éªŒè¯
   - åˆ é™¤æ‰€æœ‰å¤‡ä»½ç 
   - æ¸…é™¤ TOTP secret

### å®‰å…¨ç‰¹æ€§
- TOTP secret ä½¿ç”¨ Base32 ç¼–ç å­˜å‚¨
- å¤‡ä»½ç ä½¿ç”¨ SHA256 å“ˆå¸Œå­˜å‚¨
- éªŒè¯å¤±è´¥ä¸æ³„éœ²å…·ä½“åŸå› 
- å¤‡ä»½ç ä½¿ç”¨åç«‹å³æ ‡è®°ä¸ºå·²ä½¿ç”¨
- ç¦ç”¨ 2FA éœ€è¦å¯†ç éªŒè¯

---

## ğŸ“‹ ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼ˆå¯é€‰ï¼‰

### ä¼˜å…ˆçº§ 1ï¼šæ•°æ®åº“è¿ç§»å’Œæµ‹è¯•
1. è¿è¡Œæ•°æ®åº“è¿ç§»ï¼š
   ```bash
   sqlx migrate run --database-url postgresql://postgres:postgres@localhost:5432/cuba
   ```

2. å¯åŠ¨æœåŠ¡æµ‹è¯•ï¼š
   ```bash
   cargo run -p iam-identity
   ```

3. ä½¿ç”¨ gRPC å®¢æˆ·ç«¯æµ‹è¯• 2FA æµç¨‹ï¼š
   - è°ƒç”¨ `Enable2FA` è·å– QR ç 
   - ä½¿ç”¨ Google Authenticator æ‰«æ QR ç 
   - è°ƒç”¨ `Enable2FA` å¹¶æä¾›éªŒè¯ç å®Œæˆå¯ç”¨
   - è°ƒç”¨ `Verify2FA` æµ‹è¯• TOTP éªŒè¯
   - è°ƒç”¨ `Verify2FA` æµ‹è¯•å¤‡ä»½ç éªŒè¯
   - è°ƒç”¨ `Disable2FA` æµ‹è¯•ç¦ç”¨åŠŸèƒ½

### ä¼˜å…ˆçº§ 2ï¼šé›†æˆæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
ç¼–å†™é›†æˆæµ‹è¯•è¦†ç›–ï¼š
- [ ] å®Œæ•´çš„ 2FA å¯ç”¨æµç¨‹
- [ ] TOTP ç éªŒè¯æµç¨‹
- [ ] å¤‡ä»½ç éªŒè¯æµç¨‹
- [ ] å¤‡ä»½ç ä¸€æ¬¡æ€§ä½¿ç”¨éªŒè¯
- [ ] 2FA ç¦ç”¨æµç¨‹

### ä¼˜å…ˆçº§ 3ï¼šæ–‡æ¡£ï¼ˆå¯é€‰ï¼‰
- [ ] ç¼–å†™ 2FA ä½¿ç”¨æ–‡æ¡£
- [ ] æ·»åŠ  API æ–‡æ¡£
- [ ] æ·»åŠ æ•…éšœæ’æŸ¥æŒ‡å—

---

## ğŸ“‹ ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

### ä¼˜å…ˆçº§ 1ï¼šå®Œæˆåº”ç”¨å±‚å®ç°
1. åœ¨ User å®ä½“æ·»åŠ  `enable_2fa()` å’Œ `disable_2fa()` æ–¹æ³•
2. æ›´æ–° AuthServiceImpl æ·»åŠ  2FA ç›¸å…³ä¾èµ–
3. å®ç° `enable2_fa()` æ–¹æ³•
4. å®ç° `verify2_fa()` æ–¹æ³•
5. å®ç° `disable2_fa()` æ–¹æ³•

### ä¼˜å…ˆçº§ 2ï¼šæ›´æ–° Proto å’Œé›†æˆ
1. æ›´æ–° `auth.proto` çš„å“åº”æ¶ˆæ¯
2. é‡æ–°ç¼–è¯‘ proto æ–‡ä»¶
3. æ›´æ–° `main.rs` çš„ä¾èµ–æ³¨å…¥

### ä¼˜å…ˆçº§ 3ï¼šæµ‹è¯•
1. è¿è¡Œæ•°æ®åº“è¿ç§»
2. ç¼–å†™é›†æˆæµ‹è¯•
3. æ‰‹åŠ¨æµ‹è¯•å®Œæ•´æµç¨‹

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

- [ ] ç”¨æˆ·å¯ä»¥å¯ç”¨ 2FA
- [ ] ç”¨æˆ·å¯ä»¥æ‰«æ QR ç é…ç½® TOTP
- [ ] ç”¨æˆ·å¯ä»¥ä½¿ç”¨ TOTP ç éªŒè¯
- [ ] ç”¨æˆ·å¯ä»¥ä½¿ç”¨å¤‡ä»½ç éªŒè¯
- [ ] å¤‡ä»½ç åªèƒ½ä½¿ç”¨ä¸€æ¬¡
- [ ] ç”¨æˆ·å¯ä»¥ç¦ç”¨ 2FA
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡
- [ ] ä»£ç ç¼–è¯‘æ— é”™è¯¯

---

## ğŸ“ æŠ€æœ¯è¯´æ˜

### TOTP é…ç½®
- ç®—æ³•ï¼šSHA1
- ä½æ•°ï¼š6
- æ—¶é—´çª—å£ï¼š30 ç§’
- QR ç æ ¼å¼ï¼š`otpauth://totp/ERP%20ERP:username?secret=XXX&issuer=ERP%20ERP&algorithm=SHA1&digits=6&period=30`

### å¤‡ä»½ç 
- æ•°é‡ï¼š10 ä¸ª
- æ ¼å¼ï¼š8 ä½æ•°å­—
- å­˜å‚¨ï¼šSHA256 å“ˆå¸Œ
- ä½¿ç”¨ï¼šä¸€æ¬¡æ€§

### å®‰å…¨è€ƒè™‘
- TOTP secret ä½¿ç”¨ Base32 ç¼–ç å­˜å‚¨
- å¤‡ä»½ç ä½¿ç”¨ SHA256 å“ˆå¸Œå­˜å‚¨
- éªŒè¯å¤±è´¥ä¸æ³„éœ²å…·ä½“åŸå› 
- å¤‡ä»½ç ä½¿ç”¨åç«‹å³æ ‡è®°ä¸ºå·²ä½¿ç”¨

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

### é¢†åŸŸå±‚
- `services/iam-identity/src/auth/domain/services/totp_service.rs`
- `services/iam-identity/src/auth/domain/services/backup_code_service.rs`
- `services/iam-identity/src/auth/domain/entities/backup_code.rs`
- `services/iam-identity/src/auth/domain/repositories/backup_code_repository.rs`

### åŸºç¡€è®¾æ–½å±‚
- `services/iam-identity/src/auth/infrastructure/persistence/postgres_backup_code_repository.rs`

### æ•°æ®åº“
- `services/iam-identity/migrations/20260126011629_add_2fa_support.sql`

### é…ç½®
- `services/iam-identity/Cargo.toml` - æ·»åŠ äº† 2FA ç›¸å…³ä¾èµ–
