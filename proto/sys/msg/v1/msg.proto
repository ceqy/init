syntax = "proto3";

package sys.msg.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "common/v1/base.proto";

// ============================================================================
// 消息通知服务
// ============================================================================
service MessageService {
    // 消息发送
    rpc SendMessage(SendMessageRequest) returns (SendMessageResponse);
    rpc SendBatchMessages(SendBatchMessagesRequest) returns (SendBatchMessagesResponse);

    // 消息查询
    rpc GetMessage(GetMessageRequest) returns (GetMessageResponse);
    rpc ListMessages(ListMessagesRequest) returns (ListMessagesResponse);
    rpc GetUnreadCount(GetUnreadCountRequest) returns (GetUnreadCountResponse);

    // 消息操作
    rpc MarkAsRead(MarkAsReadRequest) returns (google.protobuf.Empty);
    rpc MarkAllAsRead(MarkAllAsReadRequest) returns (google.protobuf.Empty);
    rpc DeleteMessage(DeleteMessageRequest) returns (google.protobuf.Empty);

    // 消息模板管理
    rpc CreateMessageTemplate(CreateMessageTemplateRequest) returns (CreateMessageTemplateResponse);
    rpc GetMessageTemplate(GetMessageTemplateRequest) returns (GetMessageTemplateResponse);
    rpc UpdateMessageTemplate(UpdateMessageTemplateRequest) returns (UpdateMessageTemplateResponse);
    rpc DeleteMessageTemplate(DeleteMessageTemplateRequest) returns (google.protobuf.Empty);
    rpc ListMessageTemplates(ListMessageTemplatesRequest) returns (ListMessageTemplatesResponse);

    // 消息订阅管理
    rpc Subscribe(SubscribeRequest) returns (SubscribeResponse);
    rpc Unsubscribe(UnsubscribeRequest) returns (google.protobuf.Empty);
    rpc ListSubscriptions(ListSubscriptionsRequest) returns (ListSubscriptionsResponse);

    // 消息推送设置
    rpc UpdateNotificationSettings(UpdateNotificationSettingsRequest) returns (UpdateNotificationSettingsResponse);
    rpc GetNotificationSettings(GetNotificationSettingsRequest) returns (GetNotificationSettingsResponse);
}

// ============================================================================
// 核心实体
// ============================================================================

// 消息
message Message {
    string id = 1;                              // 消息ID (UUID)
    MessageType message_type = 2;               // 消息类型
    MessagePriority priority = 3;               // 优先级

    // 发送者
    string sender_id = 4;                       // 发送者ID
    string sender_name = 5;                     // 发送者名称

    // 接收者
    repeated string recipient_ids = 6;          // 接收者ID列表
    repeated string recipient_names = 7;        // 接收者名称列表

    // 内容
    string subject = 8;                         // 主题
    string content = 9;                         // 内容
    ContentFormat content_format = 10;          // 内容格式

    // 附件
    repeated common.v1.Attachment attachments = 11;

    // 关联
    string related_entity_type = 12;            // 关联实体类型 (如: SALES_ORDER, PURCHASE_ORDER)
    string related_entity_id = 13;              // 关联实体ID
    string related_entity_number = 14;          // 关联实体编号

    // 渠道
    repeated MessageChannel channels = 15;      // 发送渠道

    // 状态
    MessageStatus status = 16;                  // 消息状态
    google.protobuf.Timestamp sent_at = 17;     // 发送时间
    google.protobuf.Timestamp read_at = 18;     // 阅读时间
    google.protobuf.Timestamp expires_at = 19;  // 过期时间

    // 审计
    common.v1.AuditInfo audit_info = 20;
}

// 消息模板
message MessageTemplate {
    string id = 1;                              // 模板ID
    string code = 2;                            // 模板编码 (唯一)
    string name = 3;                            // 模板名称
    common.v1.LocalizedText localized_name = 4; // 多语言名称
    string description = 5;                     // 描述

    // 类型
    MessageType message_type = 6;               // 消息类型
    MessagePriority default_priority = 7;       // 默认优先级

    // 模板内容
    string subject_template = 8;                // 主题模板 (支持变量: {variable})
    string content_template = 9;                // 内容模板
    ContentFormat content_format = 10;          // 内容格式

    // 渠道
    repeated MessageChannel default_channels = 11; // 默认发送渠道

    // 变量
    repeated TemplateVariable variables = 12;   // 模板变量

    // 状态
    bool is_active = 13;                        // 是否启用

    // 审计
    common.v1.AuditInfo audit_info = 14;
}

// 模板变量
message TemplateVariable {
    string name = 1;                            // 变量名
    string description = 2;                     // 描述
    string example = 3;                         // 示例值
    bool is_required = 4;                       // 是否必填
}

// 消息订阅
message MessageSubscription {
    string id = 1;                              // 订阅ID
    string user_id = 2;                         // 用户ID
    MessageType message_type = 3;               // 消息类型
    repeated MessageChannel channels = 4;       // 订阅渠道
    bool is_active = 5;                         // 是否启用
    common.v1.AuditInfo audit_info = 6;
}

// 通知设置
message NotificationSettings {
    string user_id = 1;                         // 用户ID

    // 全局设置
    bool enable_in_app = 2;                     // 启用应用内通知
    bool enable_email = 3;                      // 启用邮件通知
    bool enable_sms = 4;                        // 启用短信通知
    bool enable_push = 5;                       // 启用推送通知

    // 免打扰
    bool do_not_disturb = 6;                    // 免打扰模式
    string dnd_start_time = 7;                  // 免打扰开始时间 (HH:mm)
    string dnd_end_time = 8;                    // 免打扰结束时间 (HH:mm)

    // 分类设置
    repeated NotificationCategorySetting category_settings = 9;
}

// 分类通知设置
message NotificationCategorySetting {
    MessageType message_type = 1;               // 消息类型
    bool enable_in_app = 2;                     // 启用应用内通知
    bool enable_email = 3;                      // 启用邮件通知
    bool enable_sms = 4;                        // 启用短信通知
    bool enable_push = 5;                       // 启用推送通知
}

// ============================================================================
// 枚举
// ============================================================================

enum MessageType {
    MESSAGE_TYPE_UNSPECIFIED = 0;
    MESSAGE_TYPE_SYSTEM = 1;                    // 系统消息
    MESSAGE_TYPE_NOTIFICATION = 2;              // 通知
    MESSAGE_TYPE_ALERT = 3;                     // 警报
    MESSAGE_TYPE_APPROVAL = 4;                  // 审批
    MESSAGE_TYPE_TASK = 5;                      // 任务
    MESSAGE_TYPE_ANNOUNCEMENT = 6;              // 公告
    MESSAGE_TYPE_CHAT = 7;                      // 聊天
}

enum MessagePriority {
    MESSAGE_PRIORITY_UNSPECIFIED = 0;
    MESSAGE_PRIORITY_LOW = 1;                   // 低
    MESSAGE_PRIORITY_NORMAL = 2;                // 普通
    MESSAGE_PRIORITY_HIGH = 3;                  // 高
    MESSAGE_PRIORITY_URGENT = 4;                // 紧急
}

enum ContentFormat {
    CONTENT_FORMAT_UNSPECIFIED = 0;
    CONTENT_FORMAT_PLAIN_TEXT = 1;              // 纯文本
    CONTENT_FORMAT_HTML = 2;                    // HTML
    CONTENT_FORMAT_MARKDOWN = 3;                // Markdown
}

enum MessageChannel {
    MESSAGE_CHANNEL_UNSPECIFIED = 0;
    MESSAGE_CHANNEL_IN_APP = 1;                 // 应用内
    MESSAGE_CHANNEL_EMAIL = 2;                  // 邮件
    MESSAGE_CHANNEL_SMS = 3;                    // 短信
    MESSAGE_CHANNEL_PUSH = 4;                   // 推送
    MESSAGE_CHANNEL_WEBHOOK = 5;                // Webhook
}

enum MessageStatus {
    MESSAGE_STATUS_UNSPECIFIED = 0;
    MESSAGE_STATUS_PENDING = 1;                 // 待发送
    MESSAGE_STATUS_SENT = 2;                    // 已发送
    MESSAGE_STATUS_READ = 3;                    // 已读
    MESSAGE_STATUS_FAILED = 4;                  // 发送失败
    MESSAGE_STATUS_EXPIRED = 5;                 // 已过期
}

// ============================================================================
// 请求/响应消息 - 消息发送
// ============================================================================

message SendMessageRequest {
    MessageType message_type = 1;
    MessagePriority priority = 2;
    string sender_id = 3;
    repeated string recipient_ids = 4;
    string subject = 5;
    string content = 6;
    ContentFormat content_format = 7;
    repeated common.v1.Attachment attachments = 8;
    string related_entity_type = 9;
    string related_entity_id = 10;
    repeated MessageChannel channels = 11;
    google.protobuf.Timestamp expires_at = 12;

    // 或使用模板
    string template_code = 13;                  // 模板编码
    map<string, string> template_variables = 14; // 模板变量
}

message SendMessageResponse {
    Message message = 1;
}

message SendBatchMessagesRequest {
    repeated SendMessageRequest messages = 1;
}

message SendBatchMessagesResponse {
    repeated common.v1.BatchOperationResult results = 1;
    int32 success_count = 2;
    int32 error_count = 3;
}

// ============================================================================
// 请求/响应消息 - 消息查询
// ============================================================================

message GetMessageRequest {
    string id = 1;
}

message GetMessageResponse {
    Message message = 1;
}

message ListMessagesRequest {
    string user_id = 1;                         // 接收者ID
    MessageType message_type = 2;
    MessageStatus status = 3;
    bool unread_only = 4;
    common.v1.DateRange date_range = 5;
    common.v1.Pagination pagination = 6;
}

message ListMessagesResponse {
    repeated Message messages = 1;
    common.v1.PaginationResponse pagination = 2;
}

message GetUnreadCountRequest {
    string user_id = 1;
    MessageType message_type = 2;
}

message GetUnreadCountResponse {
    int32 unread_count = 1;
    map<string, int32> unread_by_type = 2;      // message_type -> count
}

// ============================================================================
// 请求/响应消息 - 消息操作
// ============================================================================

message MarkAsReadRequest {
    string message_id = 1;
    string user_id = 2;
}

message MarkAllAsReadRequest {
    string user_id = 1;
    MessageType message_type = 2;               // 可选,指定类型
}

message DeleteMessageRequest {
    string message_id = 1;
    string user_id = 2;
}

// ============================================================================
// 请求/响应消息 - 消息模板管理
// ============================================================================

message CreateMessageTemplateRequest {
    string code = 1;
    string name = 2;
    common.v1.LocalizedText localized_name = 3;
    string description = 4;
    MessageType message_type = 5;
    MessagePriority default_priority = 6;
    string subject_template = 7;
    string content_template = 8;
    ContentFormat content_format = 9;
    repeated MessageChannel default_channels = 10;
    repeated TemplateVariable variables = 11;
}

message CreateMessageTemplateResponse {
    MessageTemplate template = 1;
}

message GetMessageTemplateRequest {
    oneof identifier {
        string id = 1;
        string code = 2;
    }
}

message GetMessageTemplateResponse {
    MessageTemplate template = 1;
}

message UpdateMessageTemplateRequest {
    string id = 1;
    string name = 2;
    common.v1.LocalizedText localized_name = 3;
    string description = 4;
    string subject_template = 5;
    string content_template = 6;
    ContentFormat content_format = 7;
    repeated MessageChannel default_channels = 8;
    bool is_active = 9;
}

message UpdateMessageTemplateResponse {
    MessageTemplate template = 1;
}

message DeleteMessageTemplateRequest {
    string id = 1;
}

message ListMessageTemplatesRequest {
    MessageType message_type = 1;
    bool is_active = 2;
    common.v1.Pagination pagination = 3;
}

message ListMessageTemplatesResponse {
    repeated MessageTemplate templates = 1;
    common.v1.PaginationResponse pagination = 2;
}

// ============================================================================
// 请求/响应消息 - 消息订阅管理
// ============================================================================

message SubscribeRequest {
    string user_id = 1;
    MessageType message_type = 2;
    repeated MessageChannel channels = 3;
}

message SubscribeResponse {
    MessageSubscription subscription = 1;
}

message UnsubscribeRequest {
    string subscription_id = 1;
}

message ListSubscriptionsRequest {
    string user_id = 1;
    common.v1.Pagination pagination = 2;
}

message ListSubscriptionsResponse {
    repeated MessageSubscription subscriptions = 1;
    common.v1.PaginationResponse pagination = 2;
}

// ============================================================================
// 请求/响应消息 - 消息推送设置
// ============================================================================

message UpdateNotificationSettingsRequest {
    string user_id = 1;
    bool enable_in_app = 2;
    bool enable_email = 3;
    bool enable_sms = 4;
    bool enable_push = 5;
    bool do_not_disturb = 6;
    string dnd_start_time = 7;
    string dnd_end_time = 8;
    repeated NotificationCategorySetting category_settings = 9;
}

message UpdateNotificationSettingsResponse {
    NotificationSettings settings = 1;
}

message GetNotificationSettingsRequest {
    string user_id = 1;
}

message GetNotificationSettingsResponse {
    NotificationSettings settings = 1;
}
