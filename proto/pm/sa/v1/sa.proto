syntax = "proto3";

package pm.sa.v1;


import "google/protobuf/timestamp.proto";
import "common/v1/base.proto";

service ProcurementAnalyticsService {
    rpc GetSpendAnalysis(GetSpendAnalysisRequest) returns (GetSpendAnalysisResponse);
    rpc GetSpendByCategory(GetSpendByCategoryRequest) returns (GetSpendByCategoryResponse);
    rpc GetSpendByVendor(GetSpendByVendorRequest) returns (GetSpendByVendorResponse);
    rpc GetSpendTrend(GetSpendTrendRequest) returns (GetSpendTrendResponse);

    rpc GetPurchaseOrderAnalytics(GetPurchaseOrderAnalyticsRequest) returns (GetPurchaseOrderAnalyticsResponse);
    rpc GetRequisitionAnalytics(GetRequisitionAnalyticsRequest) returns (GetRequisitionAnalyticsResponse);

    rpc GetVendorPerformanceReport(GetVendorPerformanceReportRequest) returns (GetVendorPerformanceReportResponse);
    rpc GetContractComplianceReport(GetContractComplianceReportRequest) returns (GetContractComplianceReportResponse);

    rpc GetSavingsAnalysis(GetSavingsAnalysisRequest) returns (GetSavingsAnalysisResponse);
    rpc GetCycleTimeAnalysis(GetCycleTimeAnalysisRequest) returns (GetCycleTimeAnalysisResponse);

    rpc GetProcurementDashboard(GetProcurementDashboardRequest) returns (GetProcurementDashboardResponse);
}

message GetSpendAnalysisRequest {
    string company_code = 1;
    common.v1.DateRange date_range = 2;
    string currency = 3;
}

message GetSpendAnalysisResponse {
    common.v1.Money total_spend = 1;
    common.v1.Money contracted_spend = 2;
    common.v1.Money maverick_spend = 3;
    double contract_compliance_rate = 4;
    int32 total_transactions = 5;
    int32 unique_vendors = 6;
    common.v1.Money average_po_value = 7;
    SpendComparison comparison = 8;
}

message SpendComparison {
    common.v1.Money previous_period_spend = 1;
    double change_percentage = 2;
    common.v1.Money budget = 3;
    double budget_utilization = 4;
}

message GetSpendByCategoryRequest {
    string company_code = 1;
    common.v1.DateRange date_range = 2;
    int32 limit = 3;
}

message GetSpendByCategoryResponse {
    repeated CategorySpend categories = 1;
    common.v1.Money total = 2;
}

message CategorySpend {
    string category_id = 1;
    string category_name = 2;
    string parent_category = 3;
    common.v1.Money spend = 4;
    double percentage = 5;
    int32 transaction_count = 6;
    int32 vendor_count = 7;
    double change_percentage = 8;
}

message GetSpendByVendorRequest {
    string company_code = 1;
    common.v1.DateRange date_range = 2;
    int32 limit = 3;
    string category = 4;
}

message GetSpendByVendorResponse {
    repeated VendorSpend vendors = 1;
    common.v1.Money total = 2;
}

message VendorSpend {
    string vendor_id = 1;
    string vendor_name = 2;
    common.v1.Money spend = 3;
    double percentage = 4;
    int32 po_count = 5;
    int32 invoice_count = 6;
    double on_time_delivery_rate = 7;
    double quality_score = 8;
}

message GetSpendTrendRequest {
    string company_code = 1;
    common.v1.DateRange date_range = 2;
    string granularity = 3;
    string category = 4;
}

message GetSpendTrendResponse {
    repeated SpendTrendPoint data_points = 1;
    common.v1.Money total = 2;
    double average = 3;
    double growth_rate = 4;
}

message SpendTrendPoint {
    google.protobuf.Timestamp date = 1;
    common.v1.Money spend = 2;
    int32 po_count = 3;
    int32 vendor_count = 4;
}

message GetPurchaseOrderAnalyticsRequest {
    string company_code = 1;
    common.v1.DateRange date_range = 2;
}

message GetPurchaseOrderAnalyticsResponse {
    int32 total_pos = 1;
    common.v1.Money total_value = 2;
    common.v1.Money average_po_value = 3;
    double average_lines_per_po = 4;
    double average_cycle_time_days = 5;
    int32 open_pos = 6;
    int32 overdue_pos = 7;
    repeated POByStatus by_status = 8;
    repeated POByType by_type = 9;
}

message POByStatus {
    string status = 1;
    int32 count = 2;
    common.v1.Money value = 3;
    double percentage = 4;
}

message POByType {
    string type = 1;
    int32 count = 2;
    common.v1.Money value = 3;
}

message GetRequisitionAnalyticsRequest {
    string company_code = 1;
    common.v1.DateRange date_range = 2;
}

message GetRequisitionAnalyticsResponse {
    int32 total_requisitions = 1;
    common.v1.Money total_value = 2;
    double average_approval_time_hours = 3;
    double approval_rate = 4;
    double conversion_rate = 5;
    int32 pending_approval = 6;
    repeated RequisitionByDepartment by_department = 7;
}

message RequisitionByDepartment {
    string department = 1;
    int32 count = 2;
    common.v1.Money value = 3;
    double average_approval_time = 4;
}

message GetVendorPerformanceReportRequest {
    string company_code = 1;
    common.v1.DateRange date_range = 2;
    string vendor_id = 3;
    int32 limit = 4;
}

message GetVendorPerformanceReportResponse {
    repeated VendorPerformance vendors = 1;
    VendorPerformanceSummary summary = 2;
}

message VendorPerformance {
    string vendor_id = 1;
    string vendor_name = 2;
    common.v1.Money total_spend = 3;
    int32 po_count = 4;
    double on_time_delivery_rate = 5;
    double quality_acceptance_rate = 6;
    double invoice_accuracy_rate = 7;
    double overall_score = 8;
    string rating = 9;
    VendorPerformanceTrend trend = 10;
}

message VendorPerformanceTrend {
    double delivery_trend = 1;
    double quality_trend = 2;
    double score_trend = 3;
}

message VendorPerformanceSummary {
    double average_on_time_rate = 1;
    double average_quality_rate = 2;
    double average_score = 3;
    int32 top_performers = 4;
    int32 underperformers = 5;
}

message GetContractComplianceReportRequest {
    string company_code = 1;
    common.v1.DateRange date_range = 2;
}

message GetContractComplianceReportResponse {
    common.v1.Money total_spend = 1;
    common.v1.Money contracted_spend = 2;
    common.v1.Money non_contracted_spend = 3;
    double compliance_rate = 4;
    repeated ContractUtilizationSummary contracts = 5;
    repeated NonCompliantSpend non_compliant_categories = 6;
}

message ContractUtilizationSummary {
    string contract_id = 1;
    string contract_number = 2;
    string vendor_name = 3;
    common.v1.Money target_value = 4;
    common.v1.Money utilized_value = 5;
    double utilization_rate = 6;
    int32 days_remaining = 7;
    string status = 8;
}

message NonCompliantSpend {
    string category = 1;
    common.v1.Money spend = 2;
    int32 transaction_count = 3;
    string primary_reason = 4;
}

message GetSavingsAnalysisRequest {
    string company_code = 1;
    common.v1.DateRange date_range = 2;
}

message GetSavingsAnalysisResponse {
    common.v1.Money total_savings = 1;
    common.v1.Money negotiated_savings = 2;
    common.v1.Money process_savings = 3;
    common.v1.Money consolidation_savings = 4;
    double savings_percentage = 5;
    repeated SavingsByCategory by_category = 6;
    repeated SavingsByVendor by_vendor = 7;
}

message SavingsByCategory {
    string category = 1;
    common.v1.Money savings = 2;
    double percentage = 3;
}

message SavingsByVendor {
    string vendor_id = 1;
    string vendor_name = 2;
    common.v1.Money savings = 3;
    double percentage = 4;
}

message GetCycleTimeAnalysisRequest {
    string company_code = 1;
    common.v1.DateRange date_range = 2;
}

message GetCycleTimeAnalysisResponse {
    double average_requisition_to_po_days = 1;
    double average_po_to_delivery_days = 2;
    double average_delivery_to_invoice_days = 3;
    double average_invoice_to_payment_days = 4;
    double average_total_cycle_days = 5;
    repeated CycleTimeByProcess by_process = 6;
    repeated CycleTimeTrend trend = 7;
}

message CycleTimeByProcess {
    string process = 1;
    double average_days = 2;
    double median_days = 3;
    double min_days = 4;
    double max_days = 5;
    double improvement_percentage = 6;
}

message CycleTimeTrend {
    string period = 1;
    double requisition_to_po = 2;
    double po_to_delivery = 3;
    double delivery_to_invoice = 4;
    double invoice_to_payment = 5;
}

message GetProcurementDashboardRequest {
    string company_code = 1;
    common.v1.DateRange date_range = 2;
}

message GetProcurementDashboardResponse {
    SpendSummary spend = 1;
    OrderSummary orders = 2;
    VendorSummary vendors = 3;
    ContractSummary contracts = 4;
    repeated Alert alerts = 5;
    repeated Task pending_tasks = 6;
}

message SpendSummary {
    common.v1.Money total_spend = 1;
    common.v1.Money budget = 2;
    double budget_utilization = 3;
    double change_vs_previous = 4;
    repeated SpendTrendPoint trend = 5;
}

message OrderSummary {
    int32 total_orders = 1;
    int32 pending_approval = 2;
    int32 pending_receipt = 3;
    int32 overdue = 4;
    common.v1.Money total_value = 5;
}

message VendorSummary {
    int32 active_vendors = 1;
    int32 new_vendors = 2;
    double average_performance_score = 3;
    int32 vendors_requiring_review = 4;
}

message ContractSummary {
    int32 active_contracts = 1;
    int32 expiring_soon = 2;
    common.v1.Money total_contract_value = 3;
    double average_utilization = 4;
}

message Alert {
    string id = 1;
    string type = 2;
    string severity = 3;
    string title = 4;
    string message = 5;
    string reference_id = 6;
    google.protobuf.Timestamp created_at = 7;
}

message Task {
    string id = 1;
    string type = 2;
    string title = 3;
    string description = 4;
    string reference_id = 5;
    string priority = 6;
    google.protobuf.Timestamp due_date = 7;
}
