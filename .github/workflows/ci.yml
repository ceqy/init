name: ERP CI

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "init" ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  check-and-test:
    name: Check, Lint and Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: erp_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config protobuf-compiler librdkafka-dev cmake

      - name: Remove project cargo config (macOS specific)
        run: |
          # 删除项目中包含 macOS 特定配置的 .cargo/config.toml
          rm -f .cargo/config.toml
          # 创建干净的 cargo 配置
          mkdir -p ~/.cargo
          cat > ~/.cargo/config.toml << 'EOF'
          [net]
          git-fetch-with-cli = true
          EOF

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.93"
          components: clippy, rustfmt

      - name: Install sqlx-cli
        run: cargo install sqlx-cli --no-default-features --features postgres

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run database migrations
        run: |
          # 运行所有迁移脚本
          sqlx database create || true
          for dir in services/iam-identity/migrations services/iam-access/migrations crates/adapters/postgres/migrations; do
            if [ -d "$dir" ]; then
              echo "Running migrations from $dir"
              sqlx migrate run --source "$dir" || true
            fi
          done
        env:
          DATABASE_URL: postgres://test:test@localhost:5432/erp_test

      - name: Rustfmt check
        run: cargo fmt --all -- --check

      - name: Cargo check (Workspace)
        run: cargo check --workspace --all-targets
        env:
          DATABASE_URL: postgres://test:test@localhost:5432/erp_test

      - name: Clippy lint
        run: cargo clippy --workspace --all-targets -- -D warnings
        env:
          DATABASE_URL: postgres://test:test@localhost:5432/erp_test

      - name: Run tests (Workspace)
        run: cargo test --workspace
        env:
          DATABASE_URL: postgres://test:test@localhost:5432/erp_test

  deploy:
    name: Build and Deploy (K3s)
    needs: check-and-test
    if: github.ref == 'refs/heads/init' && github.event_name == 'push'
    runs-on: self-hosted
    
    steps:
      - uses: actions/checkout@v4

      - name: Build Gateway Image
        run: |
          docker build -t gateway:latest -f gateway/Dockerfile .
          sudo k3s ctr images import <(docker save gateway:latest) || true
          # 或者如果 k3s ctr 直接支持从 docker 读取
          # sudo k3s ctr images import gateway:latest

      - name: Build IAM Identity Image
        run: |
          docker build -t iam-identity:latest -f services/iam-identity/Dockerfile .
          sudo k3s ctr images import <(docker save iam-identity:latest) || true

      - name: Build IAM Access Image
        run: |
          docker build -t iam-access:latest -f services/iam-access/Dockerfile .
          sudo k3s ctr images import <(docker save iam-access:latest) || true

      - name: Deploy to K3s
        run: |
          kubectl apply -f deploy/k3s/ingress.yaml
          kubectl apply -f deploy/k3s/services/
