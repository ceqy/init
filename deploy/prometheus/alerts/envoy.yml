# Prometheus 告警规则 - Envoy 相关

groups:
  # Envoy 健康状态告警
  - name: envoy_health
    interval: 30s
    rules:
      - alert: EnvoyDown
        expr: up{job=~"envoy.*"} == 0
        for: 1m
        labels:
          severity: critical
          service: envoy
        annotations:
          summary: "Envoy 实例宕机"
          description: "{{ $labels.instance }} Envoy 实例已宕机超过 1 分钟"

      - alert: EnvoyHighMemoryUsage
        expr: container_memory_usage_bytes{name=~".*envoy.*"} / container_spec_memory_limit_bytes{name=~".*envoy.*"} > 0.9
        for: 5m
        labels:
          severity: warning
          service: envoy
        annotations:
          summary: "Envoy 内存使用率过高"
          description: "{{ $labels.instance }} 内存使用率超过 90%"

  # Envoy 流量告警
  - name: envoy_traffic
    interval: 30s
    rules:
      - alert: EnvoyHighErrorRate
        expr: |
          (
            sum(rate(envoy_cluster_upstream_rq{envoy_response_code_class="5"}[5m])) by (envoy_cluster_name)
            /
            sum(rate(envoy_cluster_upstream_rq[5m])) by (envoy_cluster_name)
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          service: envoy
        annotations:
          summary: "Envoy 错误率过高"
          description: "集群 {{ $labels.envoy_cluster_name }} 5xx 错误率超过 5%，当前值: {{ $value | humanizePercentage }}"

      - alert: EnvoyHighLatency
        expr: |
          histogram_quantile(0.99,
            sum(rate(envoy_cluster_upstream_rq_time_bucket[5m])) by (le, envoy_cluster_name)
          ) > 1000
        for: 5m
        labels:
          severity: warning
          service: envoy
        annotations:
          summary: "Envoy 延迟过高"
          description: "集群 {{ $labels.envoy_cluster_name }} P99 延迟超过 1 秒，当前值: {{ $value }}ms"

      - alert: EnvoyHighRequestRate
        expr: sum(rate(envoy_cluster_upstream_rq[5m])) by (envoy_cluster_name) > 1000
        for: 5m
        labels:
          severity: info
          service: envoy
        annotations:
          summary: "Envoy 请求量激增"
          description: "集群 {{ $labels.envoy_cluster_name }} 请求量超过 1000 QPS"

  # Envoy 熔断器告警
  - name: envoy_circuit_breaker
    interval: 30s
    rules:
      - alert: EnvoyCircuitBreakerOpen
        expr: envoy_cluster_circuit_breakers_default_cx_open > 0
        for: 2m
        labels:
          severity: warning
          service: envoy
        annotations:
          summary: "Envoy 熔断器打开"
          description: "集群 {{ $labels.envoy_cluster_name }} 熔断器已打开，连接被拒绝"

      - alert: EnvoyCircuitBreakerOverflow
        expr: rate(envoy_cluster_circuit_breakers_default_rq_pending_overflow[5m]) > 0
        for: 2m
        labels:
          severity: warning
          service: envoy
        annotations:
          summary: "Envoy 熔断器溢出"
          description: "集群 {{ $labels.envoy_cluster_name }} 请求队列溢出"

  # Envoy 健康检查告警
  - name: envoy_health_check
    interval: 30s
    rules:
      - alert: EnvoyHealthCheckFailure
        expr: rate(envoy_cluster_health_check_failure[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: envoy
        annotations:
          summary: "Envoy 健康检查失败率高"
          description: "集群 {{ $labels.envoy_cluster_name }} 健康检查失败率超过 10%"

      - alert: EnvoyAllHostsUnhealthy
        expr: envoy_cluster_membership_healthy == 0
        for: 1m
        labels:
          severity: critical
          service: envoy
        annotations:
          summary: "Envoy 集群所有实例不健康"
          description: "集群 {{ $labels.envoy_cluster_name }} 所有后端实例都不健康"

  # Envoy 连接池告警
  - name: envoy_connection_pool
    interval: 30s
    rules:
      - alert: EnvoyConnectionPoolExhausted
        expr: envoy_cluster_upstream_cx_active >= envoy_cluster_circuit_breakers_default_cx_open
        for: 2m
        labels:
          severity: warning
          service: envoy
        annotations:
          summary: "Envoy 连接池耗尽"
          description: "集群 {{ $labels.envoy_cluster_name }} 连接池已满"

      - alert: EnvoyHighConnectionFailureRate
        expr: rate(envoy_cluster_upstream_cx_connect_fail[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: envoy
        annotations:
          summary: "Envoy 连接失败率高"
          description: "集群 {{ $labels.envoy_cluster_name }} 连接失败率超过 10%"

  # Envoy 重试告警
  - name: envoy_retry
    interval: 30s
    rules:
      - alert: EnvoyHighRetryRate
        expr: |
          (
            sum(rate(envoy_cluster_upstream_rq_retry[5m])) by (envoy_cluster_name)
            /
            sum(rate(envoy_cluster_upstream_rq[5m])) by (envoy_cluster_name)
          ) > 0.2
        for: 5m
        labels:
          severity: warning
          service: envoy
        annotations:
          summary: "Envoy 重试率过高"
          description: "集群 {{ $labels.envoy_cluster_name }} 重试率超过 20%，可能存在后端问题"

      - alert: EnvoyRetryOverflow
        expr: rate(envoy_cluster_upstream_rq_retry_overflow[5m]) > 0
        for: 2m
        labels:
          severity: warning
          service: envoy
        annotations:
          summary: "Envoy 重试预算耗尽"
          description: "集群 {{ $labels.envoy_cluster_name }} 重试预算已耗尽"
