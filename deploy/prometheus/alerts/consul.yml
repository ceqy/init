# Prometheus 告警规则 - Consul 相关

groups:
  # Consul 健康状态
  - name: consul_health
    interval: 30s
    rules:
      - alert: ConsulDown
        expr: up{job="consul"} == 0
        for: 1m
        labels:
          severity: critical
          service: consul
        annotations:
          summary: "Consul 服务宕机"
          description: "Consul 实例 {{ $labels.instance }} 已宕机超过 1 分钟"

      - alert: ConsulLeaderMissing
        expr: consul_raft_leader == 0
        for: 1m
        labels:
          severity: critical
          service: consul
        annotations:
          summary: "Consul 集群无 Leader"
          description: "Consul 集群失去 Leader，服务发现可能受影响"

      - alert: ConsulPeersMismatch
        expr: consul_raft_peers != 3
        for: 5m
        labels:
          severity: warning
          service: consul
        annotations:
          summary: "Consul 集群节点数异常"
          description: "Consul 集群节点数为 {{ $value }}，期望值为 3"

  # Consul 服务注册
  - name: consul_services
    interval: 30s
    rules:
      - alert: ConsulServiceUnhealthy
        expr: consul_health_service_status{status="critical"} > 0
        for: 2m
        labels:
          severity: warning
          service: consul
        annotations:
          summary: "Consul 服务不健康"
          description: "服务 {{ $labels.service_name }} 健康检查失败"

      - alert: ConsulServiceMissing
        expr: absent(consul_catalog_service_node_healthy{service_name="iam-access"})
        for: 2m
        labels:
          severity: critical
          service: consul
        annotations:
          summary: "关键服务未注册"
          description: "IAM Access 服务未在 Consul 中注册"

  # Consul 性能
  - name: consul_performance
    interval: 30s
    rules:
      - alert: ConsulHighMemoryUsage
        expr: process_resident_memory_bytes{job="consul"} / 1024 / 1024 / 1024 > 2
        for: 5m
        labels:
          severity: warning
          service: consul
        annotations:
          summary: "Consul 内存使用过高"
          description: "Consul 内存使用超过 2GB"

      - alert: ConsulHighCPUUsage
        expr: rate(process_cpu_seconds_total{job="consul"}[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          service: consul
        annotations:
          summary: "Consul CPU 使用率过高"
          description: "Consul CPU 使用率超过 80%"
