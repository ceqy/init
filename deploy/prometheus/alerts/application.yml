# Prometheus 告警规则 - 应用服务相关

groups:
  # 应用健康状态
  - name: application_health
    interval: 30s
    rules:
      - alert: ServiceDown
        expr: up{job=~"gateway|iam-.*"} == 0
        for: 1m
        labels:
          severity: critical
          service: application
        annotations:
          summary: "应用服务宕机"
          description: "服务 {{ $labels.job }} 实例 {{ $labels.instance }} 已宕机"

      - alert: HighMemoryUsage
        expr: |
          (
            container_memory_usage_bytes{name=~"cuba-.*"}
            /
            container_spec_memory_limit_bytes{name=~"cuba-.*"}
          ) > 0.9
        for: 5m
        labels:
          severity: warning
          service: application
        annotations:
          summary: "应用内存使用率过高"
          description: "容器 {{ $labels.name }} 内存使用率超过 90%"

      - alert: HighCPUUsage
        expr: |
          rate(container_cpu_usage_seconds_total{name=~"cuba-.*"}[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          service: application
        annotations:
          summary: "应用 CPU 使用率过高"
          description: "容器 {{ $labels.name }} CPU 使用率超过 80%"

  # 数据库告警
  - name: database
    interval: 30s
    rules:
      - alert: PostgresDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
          service: postgres
        annotations:
          summary: "PostgreSQL 数据库宕机"
          description: "PostgreSQL 实例 {{ $labels.instance }} 已宕机"

      - alert: PostgresHighConnections
        expr: pg_stat_database_numbackends / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: "PostgreSQL 连接数过高"
          description: "PostgreSQL 连接数使用率超过 80%"

      - alert: PostgresSlowQueries
        expr: rate(pg_stat_activity_max_tx_duration[5m]) > 60
        for: 5m
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: "PostgreSQL 慢查询"
          description: "存在执行时间超过 60 秒的查询"

  # Redis 告警
  - name: redis
    interval: 30s
    rules:
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "Redis 服务宕机"
          description: "Redis 实例 {{ $labels.instance }} 已宕机"

      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Redis 内存使用率过高"
          description: "Redis 内存使用率超过 90%"

      - alert: RedisHighConnectionCount
        expr: redis_connected_clients > 1000
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Redis 连接数过高"
          description: "Redis 连接数超过 1000"

  # Kafka 告警
  - name: kafka
    interval: 30s
    rules:
      - alert: KafkaDown
        expr: up{job="kafka"} == 0
        for: 1m
        labels:
          severity: critical
          service: kafka
        annotations:
          summary: "Kafka 服务宕机"
          description: "Kafka 实例 {{ $labels.instance }} 已宕机"

      - alert: KafkaHighLag
        expr: kafka_consumergroup_lag > 1000
        for: 5m
        labels:
          severity: warning
          service: kafka
        annotations:
          summary: "Kafka 消费延迟过高"
          description: "消费组 {{ $labels.consumergroup }} 延迟超过 1000 条消息"

  # 业务指标告警
  - name: business_metrics
    interval: 30s
    rules:
      - alert: HighLoginFailureRate
        expr: |
          (
            sum(rate(login_attempts_total{status="failed"}[5m]))
            /
            sum(rate(login_attempts_total[5m]))
          ) > 0.3
        for: 5m
        labels:
          severity: warning
          service: business
        annotations:
          summary: "登录失败率过高"
          description: "登录失败率超过 30%，可能存在攻击或系统问题"

      - alert: LowActiveUsers
        expr: active_users < 10
        for: 10m
        labels:
          severity: info
          service: business
        annotations:
          summary: "活跃用户数过低"
          description: "当前活跃用户数仅为 {{ $value }}"
