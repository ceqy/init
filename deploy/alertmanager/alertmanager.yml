# Alertmanager é…ç½® - å‘Šè­¦è·¯ç”±å’Œé€šçŸ¥

global:
  # SMTP é…ç½®ï¼ˆé‚®ä»¶é€šçŸ¥ï¼‰
  smtp_smarthost: 'smtp.example.com:587'
  smtp_from: 'alerts@cuba-erp.com'
  smtp_auth_username: 'alerts@cuba-erp.com'
  smtp_auth_password: 'your-password'
  smtp_require_tls: true

  # é»˜è®¤é€šçŸ¥æ¨¡æ¿
  resolve_timeout: 5m

# å‘Šè­¦è·¯ç”±è§„åˆ™
route:
  # é»˜è®¤æ¥æ”¶è€…
  receiver: 'team-ops'

  # åˆ†ç»„é…ç½®
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s        # ç­‰å¾… 10 ç§’æ”¶é›†åŒç»„å‘Šè­¦
  group_interval: 10s    # åŒç»„å‘Šè­¦é—´éš” 10 ç§’
  repeat_interval: 12h   # é‡å¤å‘Šè­¦é—´éš” 12 å°æ—¶

  # å­è·¯ç”±
  routes:
    # ä¸¥é‡å‘Šè­¦ - ç«‹å³é€šçŸ¥å¤šä¸ªæ¸ é“
    - match:
        severity: critical
      receiver: 'team-ops-critical'
      group_wait: 0s
      repeat_interval: 5m
      continue: true  # ç»§ç»­åŒ¹é…å…¶ä»–è·¯ç”±

    # æ•°æ®åº“å‘Šè­¦
    - match_re:
        service: postgres|clickhouse
      receiver: 'team-database'
      group_wait: 30s

    # Envoy å‘Šè­¦
    - match_re:
        service: envoy|gateway
      receiver: 'team-platform'

    # ä¸šåŠ¡å‘Šè­¦
    - match_re:
        alertname: .*BusinessMetric.*
      receiver: 'team-business'

# å‘Šè­¦æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # å¦‚æœé›†ç¾¤å®•æœºï¼ŒæŠ‘åˆ¶è¯¥é›†ç¾¤çš„æ‰€æœ‰å…¶ä»–å‘Šè­¦
  - source_match:
      severity: 'critical'
      alertname: 'ClusterDown'
    target_match_re:
      severity: 'warning|info'
    equal: ['cluster']

  # å¦‚æœæœåŠ¡å®Œå…¨ä¸å¯ç”¨ï¼ŒæŠ‘åˆ¶é«˜é”™è¯¯ç‡å‘Šè­¦
  - source_match:
      alertname: 'ServiceDown'
    target_match:
      alertname: 'HighErrorRate'
    equal: ['service']

# æ¥æ”¶è€…é…ç½®
receivers:
  # é»˜è®¤è¿ç»´å›¢é˜Ÿ
  - name: 'team-ops'
    email_configs:
      - to: 'ops@cuba-erp.com'
        headers:
          Subject: '[Cuba ERP] {{ .GroupLabels.alertname }}'
        html: '{{ template "email.default.html" . }}'

    # Slack é€šçŸ¥
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#ops-alerts'
        title: '{{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ end }}'
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'

  # ä¸¥é‡å‘Šè­¦ - å¤šæ¸ é“é€šçŸ¥
  - name: 'team-ops-critical'
    email_configs:
      - to: 'ops@cuba-erp.com,cto@cuba-erp.com'
        headers:
          Subject: 'ğŸš¨ [CRITICAL] {{ .GroupLabels.alertname }}'
        html: '{{ template "email.default.html" . }}'

    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#ops-critical'
        title: 'ğŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}\n{{ end }}'
        color: 'danger'

    # é’‰é’‰é€šçŸ¥
    webhook_configs:
      - url: 'http://dingtalk-webhook:8080/webhook'
        send_resolved: true

    # PagerDutyï¼ˆå¯é€‰ï¼‰
    # pagerduty_configs:
    #   - service_key: 'your-pagerduty-key'

  # æ•°æ®åº“å›¢é˜Ÿ
  - name: 'team-database'
    email_configs:
      - to: 'dba@cuba-erp.com'
        headers:
          Subject: '[Database] {{ .GroupLabels.alertname }}'

  # å¹³å°å›¢é˜Ÿ
  - name: 'team-platform'
    email_configs:
      - to: 'platform@cuba-erp.com'
        headers:
          Subject: '[Platform] {{ .GroupLabels.alertname }}'

  # ä¸šåŠ¡å›¢é˜Ÿ
  - name: 'team-business'
    email_configs:
      - to: 'business@cuba-erp.com'
        headers:
          Subject: '[Business] {{ .GroupLabels.alertname }}'

# å‘Šè­¦æ¨¡æ¿
templates:
  - '/etc/alertmanager/templates/*.tmpl'
